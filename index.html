<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì• ê²½ì¼€ë¯¸ì¹¼ í•œê°€ìœ„ ë•ë‹´ ì´ë²¤íŠ¸</title>
  <meta name="description" content="ì• ê²½ì¼€ë¯¸ì¹¼ ë™ë£Œë“¤ì—ê²Œ ì „í•˜ëŠ” ì¹­ì°¬Â·ê²©ë ¤Â·ì‘ì› ë•ë‹´ ì´ë²¤íŠ¸" />
  <meta name="theme-color" content="#005BAC" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#005BAC; } /* AKC Blue */
    html,body{ font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-b from-white to-slate-50 min-h-screen">
  <main class="mx-auto p-4 sm:p-6 lg:max-w-5xl">
    <!-- í—¤ë” -->
    <section class="mb-6 text-center">
      <!-- ë¡œê³  ìë¦¬ì— íšŒì‚¬ ë¡œê³  ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ êµì²´ -->
      <div class="mx-auto h-12 w-28 grid place-items-center rounded-lg font-extrabold text-[var(--brand)] text-xl border border-slate-200">AKC</div>
      <h1 class="mt-2 text-2xl lg:text-3xl font-extrabold tracking-tight text-[var(--brand)]">ì¶”ì„ í•œê°€ìœ„ ë•ë‹´ ì´ë²¤íŠ¸</h1>
      <p class="text-slate-600 mt-2">ìš°ë¦¬ì˜ ë¯¸ë˜ë¥¼ í–¥í•œ<b>ì¹­ì°¬Â·ê²©ë ¤Â·ì‘ì›</b> í•œë§ˆë”” ğŸŒ•ğŸ‚</p>
    </section>

    <!-- ì•ˆë‚´ ë°°ë„ˆ -->
    <div class="rounded-2xl border bg-white p-4 sm:p-5 shadow-sm">
      <p class="text-sm text-slate-600">ì‘ì„±í•œ ë•ë‹´ì€ ìš´ì˜íŒ€ ê²€í†  í›„ ì‹¤ì‹œê°„ ëª©ë¡ì— ë…¸ì¶œë©ë‹ˆë‹¤. ëª¨ë°”ì¼ì—ì„œë„ 1ë¶„ì´ë©´ ì°¸ì—¬ ì™„ë£Œ!</p>
    </div>

    <!-- ë ˆì´ì•„ì›ƒ: ëª¨ë°”ì¼ 1ì—´ / PC 2ì—´ -->
    <div class="mt-4 lg:grid lg:grid-cols-2 lg:gap-6">
      <!-- ì…ë ¥ ì¹´ë“œ -->
      <section class="rounded-2xl border bg-white shadow-sm">
        <div class="p-4 sm:p-6">
          <form id="wishForm" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-semibold mb-1" for="name">ì´ë¦„ <span class="text-slate-400 font-normal">(ì„ íƒ)</span></label>
                <input id="name" type="text" maxlength="30" class="w-full rounded-xl border-slate-300 focus:border-[var(--brand)] focus:ring-[var(--brand)]" placeholder="í™ê¸¸ë™" />
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1" for="dept">ì†Œì†/í˜„ì¥ <span class="text-slate-400 font-normal">(ì„ íƒ)</span></label>
                <input id="dept" type="text" maxlength="40" class="w-full rounded-xl border-slate-300 focus:border-[var(--brand)] focus:ring-[var(--brand)]" placeholder="ì˜ˆ: ìš¸ì‚°ê³µì¥Â·ì²­ì–‘ê³µì¥Â·ë³¸ì‚¬ ë“±" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1" for="message">ë•ë‹´ ë©”ì‹œì§€ <span class="text-[var(--brand)]">(í•„ìˆ˜)</span></label>
              <textarea id="message" rows="4" maxlength="200" class="w-full rounded-xl border-slate-300 focus:border-[var(--brand)] focus:ring-[var(--brand)]" placeholder="ì˜ˆ) ì•¼ê°„ êµëŒ€ ê·¼ë¬´ì—ë„ ëŠ˜ ì•ˆì „ ìµœìš°ì„ ! ë“ ë“ í•œ ë™ë£Œ ì—¬ëŸ¬ë¶„, í’ì„±í•œ í•œê°€ìœ„ ë³´ë‚´ì„¸ìš”!"></textarea>
              <div class="flex justify-between text-xs text-slate-500 mt-1">
                <span>ìµœëŒ€ 200ì</span>
                <span id="charCount">0 / 200</span>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <input id="anon" type="checkbox" class="rounded border-slate-300 text-[var(--brand)] focus:ring-[var(--brand)]" />
              <label for="anon" class="text-sm text-slate-700">ìµëª…ìœ¼ë¡œ ë‚¨ê¸°ê¸°</label>
            </div>

            <button id="submitBtn" type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-xl bg-[var(--brand)] px-4 py-2.5 text-white font-semibold shadow-sm hover:opacity-95 active:opacity-90">
              ë³´ë‚´ê¸°
            </button>
            <p id="status" class="mt-2 text-sm" role="status" aria-live="polite"></p>
          </form>
        </div>
      </section>

      <!-- ì‹¤ì‹œê°„ ëª©ë¡ -->
      <section class="mt-6 lg:mt-0 rounded-2xl border bg-white shadow-sm p-4 lg:sticky lg:top-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg lg:text-xl font-bold text-[var(--brand)]">ë”°ëˆí•œ ë•ë‹´</h2>
          <button id="refreshBtn" class="text-sm text-[var(--brand)] font-semibold">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <ul id="list" class="space-y-3 lg:max-h-[70vh] lg:overflow-auto lg:pr-1"></ul>
      </section>
    </div>

    <!-- í‘¸í„° -->
    <footer class="mt-10 text-center text-xs text-slate-400">Â© 2025 ì• ê²½ì¼€ë¯¸ì¹¼ ì¶”ì„ ë•ë‹´ ì´ë²¤íŠ¸</footer>
  </main>

  <script>
    // ===== í™˜ê²½ ë³€ìˆ˜ (êµì²´ í•„ìš”) =====
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxmtA286ZJ1STYpUpaIRWUJ2taRzTgZyldaAT0sYamSwloX8kmzjvBERWr_OmUOpiM/exec"; // Apps Script ì›¹ì•± URL
    const APP_TOKEN    = "AKC_2025_chuseok_!P@O#I"; // Code.gsì˜ TOKENê³¼ ë™ì¼í•˜ê²Œ

    // ===== ìœ í‹¸ =====
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $("#status");
    const btn = $("#submitBtn");
    const listEl = $("#list");
    const msgEl = $("#message");
    const countEl = $("#charCount");

    // ë¬¸ììˆ˜ ì¹´ìš´íŠ¸
    msgEl.addEventListener("input", () => { countEl.textContent = `${msgEl.value.length} / 200`; });

    // ì˜¤í”„ë¼ì¸ í (ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ì— ë³´ê´€ í›„ ì¬ì „ì†¡)
    const QUEUE_KEY = "akc_wish_queue_v1";
    const getQueue = () => JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    const setQueue = (q) => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

    async function submitWish(payload) {
      const res = await fetch(ENDPOINT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("network");
      return res.json();
    }

    function renderItem(item) {
      const name = item.isAnon === "TRUE" || item.isAnon === true ? "ìµëª…" : (item.name || "ìµëª…");
      const dept = item.dept ? ` Â· ${item.dept}` : "";
      const when = new Date(item.timestamp);
      const time = new Intl.DateTimeFormat("ko-KR", { dateStyle: "short", timeStyle: "short" }).format(when);
      const li = document.createElement("li");
      li.className = "rounded-2xl border bg-white p-4 shadow-sm";
      li.innerHTML = `
        <div class="flex items-center justify-between text-sm">
          <div class="font-semibold">${name}<span class="text-slate-500">${dept}</span></div>
          <div class="text-slate-400">${time}</div>
        </div>
        <p class="mt-2 whitespace-pre-wrap text-slate-800">${(item.message || "").replace(/[<>]/g,"")}</p>
      `;
      return li;
    }

    async function loadList() {
      try {
        const limit = matchMedia("(min-width:1024px)").matches ? 80 : 50;
        const res = await fetch(`${ENDPOINT_URL}?action=list&limit=${limit}`, { method: "GET" });
        const data = await res.json();
        listEl.innerHTML = "";
        const items = data.items || [];
        if (!items.length) {
          const empty = document.createElement("li");
          empty.className = "rounded-2xl border bg-white p-4 shadow-sm text-slate-500";
          empty.textContent = "ì•„ì§ ë•ë‹´ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë•ë‹´ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!";
          listEl.appendChild(empty);
          return;
        }
        items.forEach((it) => listEl.appendChild(renderItem(it)));
      } catch (e) {
        // ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ íŒ¨ìŠ¤
      }
    }

    // ì£¼ê¸°ì  ê°±ì‹ 
    setInterval(loadList, 10000);
    $("#refreshBtn").addEventListener("click", loadList);

    // í¼ ì œì¶œ
    $("#wishForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "";
      const payload = {
        token: APP_TOKEN,
        name: $("#name").value.trim(),
        dept: $("#dept").value.trim(),
        message: msgEl.value.trim(),
        isAnon: $("#anon").checked
      };
      if (!payload.message) {
        statusEl.textContent = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        statusEl.className = "mt-2 text-sm text-red-600";
        msgEl.focus();
        return;
      }
      btn.disabled = true;
      btn.textContent = "ì „ì†¡ ì¤‘â€¦";
      try {
        const json = await submitWish(payload);
        if (json.ok) {
          statusEl.textContent = "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
          statusEl.className = "mt-2 text-sm text-emerald-700";
          $("#wishForm").reset();
          countEl.textContent = "0 / 200";
          loadList();
        } else {
          throw new Error(json.message || "error");
        }
      } catch (err) {
        // ì˜¤í”„ë¼ì¸ í ì €ì¥
        const q = getQueue(); q.push({ ...payload, _queuedAt: Date.now() }); setQueue(q);
        statusEl.textContent = "ì˜¤í”„ë¼ì¸ ê°ì§€: ì—°ê²°ë˜ë©´ ìë™ ì¬ì „ì†¡ë©ë‹ˆë‹¤.";
        statusEl.className = "mt-2 text-sm text-orange-600";
      } finally {
        btn.disabled = false;
        btn.textContent = "ë³´ë‚´ê¸°";
      }
    });

    // ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ í ë¹„ìš°ê¸°
    window.addEventListener("online", async () => {
      const q = getQueue(); if (!q.length) return;
      statusEl.textContent = "ì—°ê²° ë³µêµ¬ë¨: ëŒ€ê¸° ë©”ì‹œì§€ ì „ì†¡ ì¤‘â€¦";
      statusEl.className = "mt-2 text-sm text-slate-600";
      const remain = [];
      for (const p of q) {
        try { await submitWish(p); } catch { remain.push(p); }
      }
      setQueue(remain);
      loadList();
      statusEl.textContent = remain.length ? `ì¼ë¶€ ë³´ë¥˜ë¨ (${remain.length})` : "ëª¨ë‘ ì „ì†¡ ì™„ë£Œ!";
    });

    // ë‹¨ì¶•í‚¤: Ctrl+Enterë¡œ ì „ì†¡(PC ì¹œí™”)
    $("#message").addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "Enter") $("#wishForm").requestSubmit();
    });

    // ì´ˆê¸° ë¡œë”©
    loadList();
  </script>
</body>
</html>